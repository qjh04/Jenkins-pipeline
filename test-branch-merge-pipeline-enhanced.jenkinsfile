pipeline {
    agent any

    // æ”¯æŒå®šæ—¶è§¦å‘ï¼Œæ¯15åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    triggers {
        cron('H/15 * * * *')
    }

    environment {
        // ä» Jenkins å‡­æ®è·å–é£ä¹¦é…ç½®
        FEISHU_APP_ID = credentials('feishu-app-id')
        FEISHU_APP_SECRET = credentials('feishu-app-secret')
        // Gitä»“åº“é…ç½®
        GIT_REPO_URL = 'git@github.com:kqq-ai/wonderLand-go.git'
        GIT_CREDENTIALS_ID = 'c96914f4-5b65-4230-a456-b9b68f46fcab'
        TARGET_BRANCH = 'test'
        // é‡è¯•é…ç½®
        MAX_RETRIES = 3
        RETRY_DELAY = 30
    }

    stages {
        stage('Checkout Test Branch') {
            steps {
                script {
                    echo "æ£€å‡ºç›®æ ‡åˆ†æ”¯: ${TARGET_BRANCH}"
                    retry(MAX_RETRIES) {
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: "*/${TARGET_BRANCH}"]],
                            doGenerateSubmoduleConfigurations: false,
                            extensions: [],
                            submoduleCfg: [],
                            userRemoteConfigs: [[
                                credentialsId: GIT_CREDENTIALS_ID,
                                url: GIT_REPO_URL
                            ]]
                        ])
                    }
                }
            }
        }

        stage('Fetch All Branches') {
            steps {
                script {
                    echo "è·å–æ‰€æœ‰è¿œç¨‹åˆ†æ”¯..."
                    retry(MAX_RETRIES) {
                        sh '''
                            git fetch --all --prune
                            git branch -r
                        '''
                    }
                }
            }
        }

        stage('Find Test Branches') {
            steps {
                script {
                    echo "æŸ¥æ‰¾ä»¥test-å¼€å¤´çš„åˆ†æ”¯..."
                    def testBranches = sh(
                        script: '''
                            git branch -r | grep "origin/test-" | sed 's/origin\///' | tr -d ' ' | sort
                        ''',
                        returnStdout: true
                    ).trim().split('\n').findAll { it }
                    
                    if (testBranches.size() == 0) {
                        echo "æ²¡æœ‰æ‰¾åˆ°ä»¥test-å¼€å¤´çš„åˆ†æ”¯"
                        currentBuild.result = 'SUCCESS'
                        env.NO_BRANCHES_FOUND = 'true'
                        return
                    }
                    
                    echo "æ‰¾åˆ°ä»¥ä¸‹test-åˆ†æ”¯: ${testBranches}"
                    env.TEST_BRANCHES = testBranches.join(',')
                    env.BRANCH_COUNT = testBranches.size().toString()
                }
            }
        }

        stage('Merge Test Branches') {
            steps {
                script {
                    if (env.TEST_BRANCHES == null || env.TEST_BRANCHES.trim() == '') {
                        echo "æ²¡æœ‰éœ€è¦åˆå¹¶çš„åˆ†æ”¯"
                        return
                    }
                    
                    def testBranches = env.TEST_BRANCHES.split(',')
                    def mergeResults = []
                    def failedBranches = []
                    def successBranches = []
                    def totalBranches = testBranches.size()
                    def processedCount = 0
                    
                    testBranches.each { branch ->
                        processedCount++
                        echo "å¤„ç†åˆ†æ”¯ ${branch} (${processedCount}/${totalBranches})"
                        
                        try {
                            // ç¡®ä¿åœ¨teståˆ†æ”¯ä¸Š
                            sh "git checkout ${TARGET_BRANCH}"
                            sh "git pull origin ${TARGET_BRANCH}"
                            
                            // æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
                            def branchExists = sh(
                                script: "git ls-remote --heads origin ${branch}",
                                returnStatus: true
                            ) == 0
                            
                            if (!branchExists) {
                                echo "åˆ†æ”¯ ${branch} ä¸å­˜åœ¨ï¼Œè·³è¿‡"
                                mergeResults.add("âš ï¸ ${branch}: åˆ†æ”¯ä¸å­˜åœ¨ï¼Œå·²è·³è¿‡")
                                continue
                            }
                            
                            // å°è¯•åˆå¹¶åˆ†æ”¯
                            def mergeResult = sh(
                                script: """
                                    git merge origin/${branch} --no-ff --no-edit
                                """,
                                returnStatus: true
                            )
                            
                            if (mergeResult == 0) {
                                echo "åˆ†æ”¯ ${branch} åˆå¹¶æˆåŠŸ"
                                successBranches.add(branch)
                                mergeResults.add("âœ… ${branch}: åˆå¹¶æˆåŠŸ")
                                
                                // æ¨é€åˆ°è¿œç¨‹
                                def pushResult = sh(
                                    script: "git push origin ${TARGET_BRANCH}",
                                    returnStatus: true
                                )
                                
                                if (pushResult == 0) {
                                    echo "åˆ†æ”¯ ${TARGET_BRANCH} æ¨é€æˆåŠŸ"
                                    
                                    // åˆ é™¤åŸåˆ†æ”¯
                                    def deleteResult = sh(
                                        script: "git push origin --delete ${branch}",
                                        returnStatus: true
                                    )
                                    
                                    if (deleteResult == 0) {
                                        echo "åˆ†æ”¯ ${branch} å·²åˆ é™¤"
                                        mergeResults.add("âœ… ${branch}: åˆå¹¶æˆåŠŸå¹¶åˆ é™¤åŸåˆ†æ”¯")
                                    } else {
                                        echo "è­¦å‘Šï¼šåˆ é™¤åˆ†æ”¯ ${branch} å¤±è´¥"
                                        mergeResults.add("âœ… ${branch}: åˆå¹¶æˆåŠŸï¼Œä½†åˆ é™¤åŸåˆ†æ”¯å¤±è´¥")
                                    }
                                } else {
                                    echo "è­¦å‘Šï¼šæ¨é€ ${TARGET_BRANCH} å¤±è´¥"
                                    mergeResults.add("âš ï¸ ${branch}: åˆå¹¶æˆåŠŸï¼Œä½†æ¨é€å¤±è´¥")
                                }
                                
                            } else {
                                echo "åˆ†æ”¯ ${branch} åˆå¹¶å¤±è´¥ï¼Œå­˜åœ¨å†²çª"
                                failedBranches.add(branch)
                                mergeResults.add("âŒ ${branch}: åˆå¹¶å¤±è´¥ - å­˜åœ¨å†²çª")
                                
                                // å–æ¶ˆåˆå¹¶
                                sh "git merge --abort"
                            }
                            
                        } catch (Exception e) {
                            echo "å¤„ç†åˆ†æ”¯ ${branch} æ—¶å‘ç”Ÿé”™è¯¯: ${e.getMessage()}"
                            failedBranches.add(branch)
                            mergeResults.add("âŒ ${branch}: å¤„ç†å¤±è´¥ - ${e.getMessage()}")
                        }
                    }
                    
                    // ä¿å­˜ç»“æœä¾›åç»­ä½¿ç”¨
                    env.MERGE_RESULTS = mergeResults.join('\n')
                    env.FAILED_BRANCHES = failedBranches.join(',')
                    env.SUCCESS_BRANCHES = successBranches.join(',')
                    env.SUCCESS_COUNT = successBranches.size().toString()
                    env.FAILED_COUNT = failedBranches.size().toString()
                    
                    // å¦‚æœæœ‰å¤±è´¥çš„åˆå¹¶ï¼ŒæŠ›å‡ºé”™è¯¯
                    if (failedBranches.size() > 0) {
                        error "ä»¥ä¸‹åˆ†æ”¯åˆå¹¶å¤±è´¥: ${failedBranches.join(', ')}"
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                try {
                    // 1. è·å–è®¿é—®ä»¤ç‰Œ
                    echo "å¼€å§‹è·å–è®¿é—®ä»¤ç‰Œ..."
                    def tokenRequestBody = """{
                        "app_id": "${FEISHU_APP_ID}",
                        "app_secret": "${FEISHU_APP_SECRET}"
                    }"""
                    
                    def tokenResponse = httpRequest(
                        url: 'https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal',
                        httpMode: 'POST',
                        contentType: 'APPLICATION_JSON',
                        requestBody: tokenRequestBody
                    )
                    
                    def tokenJson = readJSON text: tokenResponse.content
                    def accessToken = tokenJson.tenant_access_token
                    
                    if (accessToken == null || accessToken.trim() == '') {
                        error "è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥: ä»¤ç‰Œä¸ºç©º"
                    }

                    // 2. å‡†å¤‡æ¶ˆæ¯å†…å®¹
                    def buildStatus = currentBuild.result ?: 'SUCCESS'
                    def status = buildStatus == 'SUCCESS' ? 'âœ… åˆ†æ”¯åˆå¹¶æˆåŠŸ' : 'âŒ åˆ†æ”¯åˆå¹¶å¤±è´¥'
                    
                    // è·å–å½“å‰æ—¶é—´
                    def currentTime = new Date().format("yyyy-MM-dd HH:mm:ss")
                    
                    // æ„å»ºURL
                    def buildUrl = env.BUILD_URL ?: "${env.JENKINS_URL}job/${env.JOB_NAME}/${env.BUILD_NUMBER}"
                    
                    // è®¡ç®—æ„å»ºè€—æ—¶
                    def duration = currentBuild.duration
                    def durationStr = ""
                    if (duration < 1000) {
                        durationStr = "${duration}æ¯«ç§’"
                    } else if (duration < 60000) {
                        def seconds = (duration/1000).intValue()
                        durationStr = "${seconds}ç§’"
                    } else {
                        def minutes = (duration/60000).intValue()
                        def seconds = ((duration%60000)/1000).intValue()
                        durationStr = "${minutes}åˆ†${seconds}ç§’"
                    }
                    
                    // æ„å»ºè¯¦ç»†æ¶ˆæ¯
                    def messageText = "${status}\\\\n" +
                                    "æµæ°´çº¿ï¼š${JOB_NAME}\\\\n" +
                                    "æ„å»ºç¼–å·ï¼š#${BUILD_NUMBER}\\\\n" +
                                    "ç›®æ ‡åˆ†æ”¯ï¼š${TARGET_BRANCH}\\\\n" +
                                    "æ„å»ºè€—æ—¶ï¼š${durationStr}\\\\n" +
                                    "å®Œæˆæ—¶é—´ï¼š${currentTime}\\\\n" +
                                    "æ„å»ºåœ°å€ï¼š${buildUrl}\\\\n" +
                                    "æ„å»ºç»“æœï¼š${buildStatus}"
                    
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ†æ”¯
                    if (env.NO_BRANCHES_FOUND == 'true') {
                        messageText += "\\\\n\\\\nğŸ“ æ²¡æœ‰æ‰¾åˆ°éœ€è¦åˆå¹¶çš„test-åˆ†æ”¯"
                    } else {
                        // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
                        if (env.BRANCH_COUNT) {
                            messageText += "\\\\n\\\\nğŸ“Š å¤„ç†ç»Ÿè®¡ï¼š\\\\n" +
                                        "æ€»åˆ†æ”¯æ•°ï¼š${env.BRANCH_COUNT}"
                        }
                        
                        if (env.SUCCESS_COUNT && env.SUCCESS_COUNT != '0') {
                            messageText += "\\\\næˆåŠŸåˆå¹¶ï¼š${env.SUCCESS_COUNT}"
                        }
                        
                        if (env.FAILED_COUNT && env.FAILED_COUNT != '0') {
                            messageText += "\\\\nå¤±è´¥åˆ†æ”¯ï¼š${env.FAILED_COUNT}"
                        }
                        
                        // å¦‚æœæœ‰åˆå¹¶ç»“æœï¼Œæ·»åŠ åˆ°æ¶ˆæ¯ä¸­
                        if (env.MERGE_RESULTS) {
                            messageText += "\\\\n\\\\nåˆå¹¶è¯¦æƒ…ï¼š\\\\n${env.MERGE_RESULTS}"
                        }
                        
                        // å¦‚æœæœ‰å¤±è´¥çš„åˆ†æ”¯ï¼Œæ·»åŠ åˆ°æ¶ˆæ¯ä¸­
                        if (env.FAILED_BRANCHES && env.FAILED_BRANCHES.trim() != '') {
                            messageText += "\\\\n\\\\nå¤±è´¥åˆ†æ”¯ï¼š${env.FAILED_BRANCHES}"
                        }
                    }
                    
                    echo "å‘é€çš„æ¶ˆæ¯å†…å®¹: ${messageText}"
                    
                    // 3. è·å–ç”¨æˆ·çš„ open_id
                    def userList = env.FEISHU_USER_LIST.split(',')
                    def mobileQueryString = userList.collect { "mobiles=${it}" }.join('&')
                    def userResponse = httpRequest(
                        url: "https://open.feishu.cn/open-apis/user/v1/batch_get_id?${mobileQueryString}",
                        httpMode: 'GET',
                        customHeaders: [[
                            name: 'Authorization',
                            value: "Bearer ${accessToken}"
                        ]],
                        validResponseCodes: '100:599'
                    )
                    
                    def userJson = readJSON text: userResponse.content
                    def mobileUsers = userJson.data.mobile_users
                    def mobilesNotExist = userJson.data.mobiles_not_exist ?: []
                    
                    if (mobilesNotExist.size() > 0) {
                        def notExistList = ""
                        mobilesNotExist.each { mobile ->
                            if (notExistList) {
                                notExistList += ", "
                            }
                            notExistList += mobile
                        }
                        echo "è­¦å‘Šï¼šä»¥ä¸‹æ‰‹æœºå·æœªæ‰¾åˆ°å¯¹åº”ç”¨æˆ·ï¼š${notExistList}"
                    }
                    
                    // 4. å‘é€æ¶ˆæ¯ç»™æ¯ä¸ªæœ‰æ•ˆç”¨æˆ·
                    def failedUsers = []
                    
                    mobileUsers.each { mobile, users ->
                        users.each { user ->
                            def userId = user.open_id
                            def messagePayload = """{
                                "receive_id": "${userId}",
                                "msg_type": "text",
                                "content": "{\\\"text\\\":\\\"${messageText}\\\"}"
                            }"""
                            
                            try {
                                def response = httpRequest(
                                    url: 'https://open.feishu.cn/open-apis/im/v1/messages?receive_id_type=open_id',
                                    httpMode: 'POST',
                                    customHeaders: [[
                                        name: 'Authorization',
                                        value: "Bearer ${accessToken}"
                                    ], [
                                        name: 'Content-Type',
                                        value: 'application/json; charset=utf-8'
                                    ]],
                                    requestBody: messagePayload.trim(),
                                    validResponseCodes: '100:599'
                                )
                                
                                if (response.status >= 400) {
                                    def errorJson = readJSON text: response.content
                                    echo "å‘é€ç»™ç”¨æˆ· ${mobile}(${userId}) å¤±è´¥: ${errorJson.msg}"
                                    failedUsers.add(mobile)
                                }
                            } catch (Exception e) {
                                echo "å‘é€ç»™ç”¨æˆ· ${mobile}(${userId}) æ—¶å‘ç”Ÿé”™è¯¯: ${e.getMessage()}"
                                failedUsers.add(mobile)
                            }
                        }
                    }
                    
                    // 5. è¾“å‡ºå‘é€ç»“æœç»Ÿè®¡
                    def totalUsers = userList.size()
                    def successUsers = totalUsers - failedUsers.size() - mobilesNotExist.size()
                    echo "æ¶ˆæ¯å‘é€å®Œæˆï¼ŒæˆåŠŸï¼š${successUsers}ï¼Œå¤±è´¥ï¼š${failedUsers.size()}ï¼Œæœªæ‰¾åˆ°ç”¨æˆ·ï¼š${mobilesNotExist.size()}"
                    if (failedUsers.size() > 0) {
                        def failedList = ""
                        failedUsers.each { mobile ->
                            if (failedList) {
                                failedList += ", "
                            }
                            failedList += mobile
                        }
                        echo "å‘é€å¤±è´¥çš„ç”¨æˆ·: ${failedList}"
                    }
                    
                } catch (Exception e) {
                    echo "å‘é€é£ä¹¦é€šçŸ¥å¤±è´¥: ${e.getMessage()}"
                    echo "è¯¦ç»†é”™è¯¯: ${e.toString()}"
                }
            }
        }
    }
} 