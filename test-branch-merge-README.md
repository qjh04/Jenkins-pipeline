# Test分支自动合并流水线

## 功能描述

这个Jenkins流水线用于自动检测GitHub仓库中以`test-`开头的分支，并将它们合并到`test`分支中。

## 主要功能

1. **自动检测**: 自动查找所有以`test-`开头的远程分支
2. **冲突检测**: 在合并过程中检测冲突，如果存在冲突则停止合并并报错
3. **自动合并**: 如果没有冲突，自动合并到`test`分支
4. **分支清理**: 合并成功后自动删除原始的`test-`分支
5. **通知机制**: 通过飞书发送合并结果通知

## 流水线阶段

### 1. Checkout Test Branch
- 检出目标`test`分支

### 2. Fetch All Branches
- 获取所有远程分支信息

### 3. Find Test Branches
- 查找所有以`test-`开头的分支
- 如果没有找到相关分支，流水线成功结束

### 4. Merge Test Branches
- 逐个处理每个`test-`分支
- 尝试合并到`test`分支
- 如果合并成功：
  - 推送到远程仓库
  - 删除原始的`test-`分支
- 如果合并失败（存在冲突）：
  - 取消合并操作
  - 记录失败信息
  - 继续处理下一个分支

## 配置要求

### Jenkins凭据
需要在Jenkins中配置以下凭据：

1. **Git凭据**: `c96914f4-5b65-4230-a456-b9b68f46fcab`
   - 用于访问GitHub仓库

2. **飞书应用凭据**:
   - `feishu-app-id`: 飞书应用的App ID
   - `feishu-app-secret`: 飞书应用的App Secret

### 环境变量
需要在Jenkins中配置以下环境变量：

- `FEISHU_USER_LIST`: 接收通知的用户手机号列表，用逗号分隔

## 使用方法

### 手动触发
1. 在Jenkins中创建新的流水线任务
2. 使用`test-branch-merge-pipeline.jenkinsfile`作为流水线定义
3. 手动触发流水线执行

### 自动触发
可以配置以下触发方式：

1. **定时触发**: 设置定时任务，定期检查并合并分支
2. **Webhook触发**: 配置GitHub Webhook，当有新的`test-`分支时触发
3. **轮询触发**: 定期轮询GitHub仓库变化

## 示例配置

### 定时触发配置
在Jenkins流水线中添加：
```groovy
triggers {
    cron('H/15 * * * *')  // 每15分钟执行一次
}
```

### Webhook触发配置
在GitHub仓库中配置Webhook：
- URL: `http://your-jenkins-url/github-webhook/`
- Content type: `application/json`
- 选择事件: `Push` 和 `Create`

## 错误处理

### 合并冲突
当检测到合并冲突时：
1. 流水线会立即停止合并操作
2. 使用`git merge --abort`取消合并
3. 记录冲突信息
4. 通过飞书发送失败通知
5. 流水线标记为失败

### 网络问题
如果遇到网络连接问题：
1. 重试机制会自动处理临时网络问题
2. 如果持续失败，会发送错误通知

## 通知内容

### 成功通知
- ✅ 分支合并成功
- 包含合并的分支列表
- 构建耗时和完成时间

### 失败通知
- ❌ 分支合并失败
- 包含失败的分支列表和原因
- 构建耗时和完成时间

## 注意事项

1. **权限要求**: 确保Jenkins有足够的权限来推送和删除分支
2. **分支命名**: 只有以`test-`开头的分支才会被处理
3. **冲突处理**: 存在冲突的分支不会被合并，需要手动解决
4. **通知配置**: 确保飞书应用配置正确，用户列表有效

## 故障排除

### 常见问题

1. **Git权限错误**
   - 检查SSH密钥配置
   - 确认Jenkins用户有仓库访问权限

2. **飞书通知失败**
   - 检查飞书应用配置
   - 确认用户手机号格式正确

3. **分支删除失败**
   - 确认有删除分支的权限
   - 检查分支是否已被其他流程删除

### 日志查看
在Jenkins构建日志中可以查看详细的执行过程：
- 每个分支的处理状态
- 合并操作的详细输出
- 错误信息和堆栈跟踪 